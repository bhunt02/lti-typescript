{"version":3,"file":"dynamic_registration.js","sourceRoot":"/","sources":["provider/services/dynamic_registration.ts"],"names":[],"mappings":";;;AACA,iCAAiC;AACjC,uCAAuC;AACvC,iDAAqD;AACrD,mDAA8C;AAC9C,oEAA6D;AAC7D,6CAAwC;AAExC,6CAO2B;AAE3B,MAAa,0BAA0B;IAcrC,YACU,QAAkB,EAC1B,OAAmC,EACnC,MAAqE;QAF7D,aAAQ,GAAR,QAAQ,CAAU;QAI1B,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;QACzB,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC,YAAY,IAAI,EAAE,CAAC;QAC/C,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC,gBAAgB,IAAI,EAAE,CAAC;QACvD,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,cAAc;YACjB,OAAO,CAAC,cAAc,KAAK,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,cAAc,CAAC;QACvE,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;QACzB,IAAI,CAAC,WAAW,GAAG,OAAO,CAAC,WAAW,CAAC;QACvC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAC9C,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC;QAC1D,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;QAC9D,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,EAAE,MAAM,CAAC,WAAW,CAAC,CAAC;IAClE,CAAC;IAGO,QAAQ,CAAC,GAAW,EAAE,IAAY;QACxC,IAAI,IAAI,KAAK,GAAG;YAAE,OAAO,GAAG,CAAC;QAC7B,MAAM,SAAS,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACjC,MAAM,SAAS,GAAG,SAAS,CAAC,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;QACtD,IAAI,SAAS,EAAE,CAAC;YACd,SAAS,CAAC,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YAC5C,SAAS,CAAC,QAAQ,GAAG,SAAS,CAAC,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QACvE,CAAC;QACD,OAAO,GAAG,CAAC,MAAM,CAAC;YAChB,QAAQ,EAAE,SAAS,CAAC,QAAQ;YAC5B,QAAQ,EAAE,SAAS,CAAC,QAAQ;YAC5B,QAAQ,EAAE,CAAC,SAAS,CAAC,QAAQ,GAAG,IAAI,CAAC,CAAC,OAAO,CAAC,IAAI,EAAE,GAAG,CAAC;YACxD,IAAI,EAAE,SAAS,CAAC,IAAI;YACpB,IAAI,EAAE,SAAS,CAAC,IAAI;YACpB,IAAI,EAAE,SAAS,CAAC,IAAI;YACpB,MAAM,EAAE,SAAS,CAAC,MAAM;SACzB,CAAC,CAAC;IACL,CAAC;IAGO,WAAW,CAAC,GAAW;QAC7B,MAAM,SAAS,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACjC,IAAI,QAAQ,GAAG,SAAS,CAAC,QAAQ,CAAC;QAClC,IAAI,SAAS,CAAC,IAAI;YAAE,QAAQ,IAAI,GAAG,GAAG,SAAS,CAAC,IAAI,CAAC;QACrD,OAAO,QAAQ,CAAC;IAClB,CAAC;IAQD,KAAK,CAAC,QAAQ,CACZ,mBAA2B,EAC3B,iBAAyB,EACzB,OAA6C;QAE7C,IAAI,CAAC,mBAAmB;YAAE,MAAM,IAAI,KAAK,CAAC,8BAA8B,CAAC,CAAC;QAC1E,aAAK,CAAC,GAAG,CAAC,IAAI,EAAE,uCAAuC,CAAC,CAAC;QAEzD,MAAM,aAAa,GAAwB,MAAM,KAAK,CACpD,mBAAmB,EACnB;YACE,MAAM,EAAE,KAAK;SACd,CACF;aACE,IAAI,CAAC,CAAC,QAAQ,EAAE,EAAE;YACjB,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;gBACjB,MAAM,EAAE,MAAM,EAAE,QAAQ,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,UAAU,EAAE,CAAC;YAClE,CAAC;YACD,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;QACzB,CAAC,CAAC;aACD,KAAK,CAAC,CAAC,GAAG,EAAE,EAAE;YACb,IAAI,QAAQ,IAAI,GAAG,EAAE,CAAC;gBACpB,MAAM,IAAI,KAAK,CAAC,GAAG,GAAG,CAAC,MAAM,KAAK,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC;YACnD,CAAC;YACD,MAAM,GAAG,CAAC;QACZ,CAAC,CAAC,CAAC;QAEL,aAAK,CAAC,GAAG,CACP,IAAI,EACJ,+CAA+C,EAC/C,aAAa,CAAC,MAAM,CACrB,CAAC;QAEF,MAAM,QAAQ,GAAG,CAAC,EAAE,IAAI,EAAE,wBAAwB,EAAE,CAAC,CAAC;QACtD,IAAI,IAAI,CAAC,cAAc;YAAE,QAAQ,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,uBAAuB,EAAE,CAAC,CAAC;QAC1E,MAAM,YAAY,GAAG,IAAA,0BAAgB,EACnC;YACE,gBAAgB,EAAE,KAAK;YACvB,cAAc,EAAE,CAAC,UAAU,CAAC;YAC5B,WAAW,EAAE,CAAC,oBAAoB,EAAE,UAAU,CAAC;YAC/C,kBAAkB,EAAE,IAAI,CAAC,QAAQ;YACjC,aAAa,EAAE,CAAC,GAAG,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,MAAM,CAAC;YAClD,WAAW,EAAE,IAAI,CAAC,IAAI;YACtB,QAAQ,EAAE,IAAI,CAAC,SAAS;YACxB,QAAQ,EAAE,IAAI,CAAC,IAAI;YACnB,0BAA0B,EAAE,iBAAiB;YAC7C,KAAK,EAAE;gBACL,iEAAiE;gBACjE,wDAAwD;gBACxD,qDAAqD;gBACrD,+DAA+D;gBAC/D,2EAA2E;aAC5E,CAAC,IAAI,CAAC,GAAG,CAAC;YACX,wDAAwD,EAAE;gBACxD,MAAM,EAAE,IAAI,CAAC,QAAQ;gBACrB,WAAW,EAAE,IAAI,CAAC,WAAW;gBAC7B,eAAe,EAAE,IAAI,CAAC,MAAM;gBAC5B,iBAAiB,EAAE,IAAI,CAAC,gBAAgB;gBACxC,MAAM,EAAE,aAAa,CAAC,gBAAgB;gBACtC,QAAQ;aACT;SACoB,EACvB,OAAO,CACR,CAAC;QACF,aAAK,CAAC,GAAG,CACP,IAAI,EACJ,8BAA8B,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,EAAE,CAC7D,CAAC;QACF,aAAK,CAAC,GAAG,CAAC,IAAI,EAAE,mCAAmC,CAAC,CAAC;QACrD,MAAM,oBAAoB,GAA4B,MAAM,KAAK,CAC/D,aAAa,CAAC,qBAAqB,EACnC;YACE,MAAM,EAAE,MAAM;YACd,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC;YAClC,OAAO,EAAE;gBACP,cAAc,EAAE,kBAAkB;gBAClC,GAAG,CAAC,iBAAiB;oBACnB,CAAC,CAAC,EAAE,aAAa,EAAE,SAAS,GAAG,iBAAiB,EAAE;oBAClD,CAAC,CAAC,SAAS,CAAC;aACf;SACF,CACF;aACE,IAAI,CAAC,CAAC,QAAQ,EAAE,EAAE;YACjB,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC;gBACjB,MAAM,EAAE,MAAM,EAAE,QAAQ,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,UAAU,EAAE,CAAC;YAClE,CAAC;YACD,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;QACzB,CAAC,CAAC;aACD,KAAK,CAAC,CAAC,GAAG,EAAE,EAAE;YACb,IAAI,QAAQ,IAAI,GAAG,EAAE,CAAC;gBACpB,MAAM,IAAI,KAAK,CAAC,GAAG,GAAG,CAAC,MAAM,KAAK,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC;YACnD,CAAC;YACD,MAAM,GAAG,CAAC;QACZ,CAAC,CAAC,CAAC;QAGL,MAAM,YAAY,GAChB,CAAC,aAAa,CACZ,4DAA4D,CAC7D;YACC,CAAC,CAAC,aAAa,CACX,4DAA4D,CAC7D,CAAC,mBAAmB;YACvB,CAAC,CAAC,UAAU,CAAC;YACf,UAAU;YACV,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAEzC,IACE,MAAM,IAAI,CAAC,QAAQ,CAAC,WAAW,CAC7B,aAAa,CAAC,MAAM,EACpB,oBAAoB,CAAC,SAAS,CAC/B;YAED,MAAM,IAAI,KAAK,CAAC,6BAA6B,CAAC,CAAC;QAEjD,aAAK,CAAC,GAAG,CAAC,IAAI,EAAE,sBAAsB,CAAC,CAAC;QACxC,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,gBAAgB,CAAC;YACtD,WAAW,EAAE,aAAa,CAAC,MAAM;YACjC,IAAI,EAAE,YAAY;YAClB,QAAQ,EAAE,oBAAoB,CAAC,SAAS;YACxC,sBAAsB,EAAE,aAAa,CAAC,sBAAsB;YAC5D,mBAAmB,EAAE,aAAa,CAAC,cAAc;YACjD,mBAAmB,EAAE,aAAa,CAAC,oBAAoB;YACvD,SAAS,EAAE;gBACT,MAAM,EAAE,2BAAmB,CAAC,OAAO;gBACnC,GAAG,EAAE,aAAa,CAAC,QAAQ;aAC5B;YACD,MAAM,EAAE,IAAI,CAAC,YAAY;SAC1B,CAAC,CAAC;QACH,MAAM,mBAAQ,CAAC,MAAM,CACnB,+BAAa,EACb,EAAE,MAAM,EAAE,IAAI,CAAC,YAAY,EAAE,EAC7B,EAAE,GAAG,EAAE,UAAU,CAAC,GAAG,EAAE,CACxB,CAAC;QAGF,OAAO,0GAA0G,CAAC;IACpH,CAAC;CACF;AA7MD,gEA6MC","sourcesContent":["/* Provider Dynamic Registration Service */\nimport * as crypto from 'crypto';\nimport * as Url from 'fast-url-parser';\nimport {deepMergeObjects} from '../../utils/objects';\nimport {Database} from '../../utils/database';\nimport {PlatformModel} from '../../entities/platform.entity';\nimport {Debug} from '../../utils/debug';\nimport {Provider} from '../provider';\nimport {\n  AuthTokenMethodEnum,\n  DynamicRegistrationOptions,\n  DynamicRegistrationSecondaryOptions,\n  OpenIdConfiguration,\n  OpenIdRegistration,\n  ToolOpenIdConfiguration,\n} from '../../utils/types';\n\nexport class DynamicRegistrationService {\n  private readonly name: string;\n  private readonly redirectUris: string[];\n  private readonly customParameters: Record<string, any>;\n  private readonly autoActivate: boolean;\n  private readonly useDeepLinking: boolean;\n  private readonly logo: string;\n  private readonly description: string;\n  private readonly hostname: string;\n\n  private readonly appUrl: string;\n  private readonly loginUrl: string;\n  private readonly keysetUrl: string;\n\n  constructor(\n    private provider: Provider,\n    options: DynamicRegistrationOptions,\n    routes: { appRoute: string; loginRoute: string; keySetRoute: string },\n  ) {\n    this.name = options.name;\n    this.redirectUris = options.redirectUris || [];\n    this.customParameters = options.customParameters || {};\n    this.autoActivate = options.autoActivate;\n    this.useDeepLinking =\n      options.useDeepLinking === undefined ? true : options.useDeepLinking;\n    this.logo = options.logo;\n    this.description = options.description;\n    this.hostname = this.getHostname(options.url);\n    this.appUrl = this.buildUrl(options.url, routes.appRoute);\n    this.loginUrl = this.buildUrl(options.url, routes.loginRoute);\n    this.keysetUrl = this.buildUrl(options.url, routes.keySetRoute);\n  }\n\n  // Helper method to build URLs\n  private buildUrl(url: string, path: string) {\n    if (path === '/') return url;\n    const pathParts = Url.parse(url);\n    const portMatch = pathParts.pathname.match(/:[0-9]*/);\n    if (portMatch) {\n      pathParts.port = portMatch[0].split(':')[1];\n      pathParts.pathname = pathParts.pathname.split(portMatch[0]).join('');\n    }\n    return Url.format({\n      protocol: pathParts.protocol,\n      hostname: pathParts.hostname,\n      pathname: (pathParts.pathname + path).replace('//', '/'),\n      port: pathParts.port,\n      auth: pathParts.auth,\n      hash: pathParts.hash,\n      search: pathParts.search,\n    });\n  }\n\n  // Helper method to get the url hostname\n  private getHostname(url: string) {\n    const pathParts = Url.parse(url);\n    let hostname = pathParts.hostname;\n    if (pathParts.port) hostname += ':' + pathParts.port;\n    return hostname;\n  }\n\n  /**\n   * @description Performs dynamic registration flow.\n   * @param {String} openIdConfiguration - OpenID configuration URL. Retrieved from req.query.openid_configuration.\n   * @param {String} registrationToken - Registration Token. Retrieved from req.query.registration_token.\n   * @param {Partial<DynamicRegistrationOptions> & Partial<DynamicRegistrationSecondaryOptions>} [options] - Replacements or extensions to default registration options.\n   */\n  async register(\n    openIdConfiguration: string,\n    registrationToken: string,\n    options?: DynamicRegistrationSecondaryOptions,\n  ) {\n    if (!openIdConfiguration) throw new Error('MISSING_OPENID_CONFIGURATION');\n    Debug.log(this, 'Starting dynamic registration process');\n    // Get Platform registration configurations\n    const configuration: OpenIdConfiguration = await fetch(\n      openIdConfiguration,\n      {\n        method: 'GET',\n      },\n    )\n      .then((response) => {\n        if (!response.ok) {\n          throw { status: response.status, message: response.statusText };\n        }\n        return response.json();\n      })\n      .catch((err) => {\n        if ('status' in err) {\n          throw new Error(`${err.status}: ${err.message}`);\n        }\n        throw err;\n      });\n\n    Debug.log(\n      this,\n      'Attempting to register Platform with issuer: ',\n      configuration.issuer,\n    );\n    // Building registration object\n    const messages = [{ type: 'LtiResourceLinkRequest' }];\n    if (this.useDeepLinking) messages.push({ type: 'LtiDeepLinkingRequest' });\n    const registration = deepMergeObjects(\n      {\n        application_type: 'web',\n        response_types: ['id_token'],\n        grant_types: ['client_credentials', 'implicit'],\n        initiate_login_uri: this.loginUrl,\n        redirect_uris: [...this.redirectUris, this.appUrl],\n        client_name: this.name,\n        jwks_uri: this.keysetUrl,\n        logo_uri: this.logo,\n        token_endpoint_auth_method: 'private_key_jwt',\n        scope: [\n          'https://purl.imsglobal.org/spec/lti-ags/scope/lineitem.readonly',\n          'https://purl.imsglobal.org/spec/lti-ags/scope/lineitem',\n          'https://purl.imsglobal.org/spec/lti-ags/scope/score',\n          'https://purl.imsglobal.org/spec/lti-ags/scope/result.readonly',\n          'https://purl.imsglobal.org/spec/lti-nrps/scope/contextmembership.readonly',\n        ].join(' '),\n        'https://purl.imsglobal.org/spec/lti-tool-configuration': {\n          domain: this.hostname,\n          description: this.description,\n          target_link_uri: this.appUrl,\n          custom_parameters: this.customParameters,\n          claims: configuration.claims_supported,\n          messages,\n        },\n      } as OpenIdRegistration,\n      options,\n    );\n    Debug.log(\n      this,\n      `Tool registration request: ${JSON.stringify(registration)}`,\n    );\n    Debug.log(this, 'Sending Tool registration request');\n    const registrationResponse: ToolOpenIdConfiguration = await fetch(\n      configuration.registration_endpoint,\n      {\n        method: 'POST',\n        body: JSON.stringify(registration),\n        headers: {\n          'Content-Type': 'application/json',\n          ...(registrationToken\n            ? { Authorization: 'Bearer ' + registrationToken }\n            : undefined),\n        },\n      },\n    )\n      .then((response) => {\n        if (!response.ok) {\n          throw { status: response.status, message: response.statusText };\n        }\n        return response.json();\n      })\n      .catch((err) => {\n        if ('status' in err) {\n          throw new Error(`${err.status}: ${err.message}`);\n        }\n        throw err;\n      });\n\n    // Registering Platform\n    const platformName =\n      (configuration[\n        'https://purl.imsglobal.org/spec/lti-platform-configuration'\n      ]\n        ? configuration[\n            'https://purl.imsglobal.org/spec/lti-platform-configuration'\n          ].product_family_code\n        : 'Platform') +\n      '_DynReg_' +\n      crypto.randomBytes(16).toString('hex');\n\n    if (\n      await this.provider.getPlatform(\n        configuration.issuer,\n        registrationResponse.client_id,\n      )\n    )\n      throw new Error('PLATFORM_ALREADY_REGISTERED');\n\n    Debug.log(this, 'Registering Platform');\n    const registered = await this.provider.registerPlatform({\n      platformUrl: configuration.issuer,\n      name: platformName,\n      clientId: registrationResponse.client_id,\n      authenticationEndpoint: configuration.authorization_endpoint,\n      accessTokenEndpoint: configuration.token_endpoint,\n      authorizationServer: configuration.authorization_server,\n      authToken: {\n        method: AuthTokenMethodEnum.JWK_SET,\n        key: configuration.jwks_uri,\n      },\n      active: this.autoActivate,\n    });\n    await Database.update(\n      PlatformModel,\n      { active: this.autoActivate },\n      { kid: registered.kid },\n    );\n\n    // Returing message indicating the end of registration flow\n    return '<script>(window.opener || window.parent).postMessage({subject:\"org.imsglobal.lti.close\"}, \"*\");</script>';\n  }\n}\n"]}